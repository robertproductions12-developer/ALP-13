<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="https://i.ibb.co/bRgBcNkd/a-bold-logo-design-featuring-the-letters-em-SC-r-FBQ4-O6y0-WUPQAUu-A-ay-N6fa2-SQF6-Pw-O1r-KAR9-FA.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALP 13 Inventario Pro</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Segoe UI', sans-serif; 
            color: #e0e0e0; 
            background-color: #000;
            overflow: hidden; /* Evita scroll en el body, lo haremos en el contenido */
        }

        /* FONDO GRADIENTE */
        body {
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        }

        /* --- ANIMACI√ìN DE FONDO --- */
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
        }

        .floating-graphic {
            position: absolute;
            color: rgba(187, 134, 252, 0.25);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            user-select: none;
            text-shadow: 0 0 10px rgba(187, 134, 252, 0.5);
            animation: floatUp linear infinite;
            bottom: -100px;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg) scale(0.8); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-20vh) rotate(360deg) scale(1.2); opacity: 0; }
        }

        /* --- LAYOUT PRINCIPAL (SIDEBAR + CONTENIDO) --- */
        #app-view {
            display: none; 
            width: 100%; height: 100%; 
            /* Flexbox para poner sidebar y contenido lado a lado */
            display: flex; 
            flex-direction: row; 
            overflow: hidden;
        }
        
        /* Ocultar app-view inicialmente hasta el login */
        body.not-logged-in #app-view { display: none !important; }

        /* --- SIDEBAR LATERAL --- */
        .sidebar {
            width: 260px;
            background: rgba(20, 10, 35, 0.95);
            border-right: 1px solid #4a148c;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .sidebar-title {
            font-size: 1.8rem;
            color: #d1b3ff;
            text-shadow: 0 0 10px #aa00ff;
            margin: 0;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .nav-links {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-btn {
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid transparent;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            padding-left: 20px;
        }

        .nav-btn.active {
            background: linear-gradient(90deg, rgba(74, 20, 140, 0.4), transparent);
            border-left: 4px solid #00e676;
            color: #00e676;
            font-weight: bold;
        }

        .btn-logout {
            padding: 12px;
            background: rgba(255, 23, 68, 0.1);
            color: #ff1744;
            border: 1px solid #ff1744;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-top: 20px;
            transition: 0.3s;
        }
        .btn-logout:hover { background: #ff1744; color: white; }

        /* --- √ÅREA DE CONTENIDO --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Scroll solo en el contenido */
            position: relative;
            z-index: 10;
        }

        /* CABECERA M√ìVIL (Solo visible en pantallas peque√±as) */
        .mobile-header {
            display: none;
            padding: 15px;
            background: rgba(20, 10, 35, 0.95);
            border-bottom: 1px solid #4a148c;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0; z-index: 101;
        }

        .menu-toggle {
            background: none; border: none; color: #d1b3ff; font-size: 1.5rem; cursor: pointer;
        }

        /* --- CONTENEDORES --- */
        .login-box, .seccion {
            background: rgba(20, 20, 20, 0.85); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            padding: 20px; margin-bottom: 20px;
            width: 100%; box-sizing: border-box;
        }

        h2, h3 { 
            color: #d1b3ff; border-bottom: 1px solid #4a148c; 
            padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
            font-size: 1.2rem;
        }

        /* --- DASHBOARD 3D --- */
        .dashboard-container { margin-top: 20px; }
        .dash-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            padding: 10px;
            perspective: 1000px;
        }

        .dash-card {
            background: linear-gradient(135deg, rgba(74, 20, 140, 0.8), rgba(10, 10, 10, 0.95));
            border: 1px solid #7b1fa2;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg);
            transition: transform 0.1s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dash-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .dash-card:hover::before { opacity: 1; }
        .dash-card:hover { border-color: #d500f9; box-shadow: 0 20px 40px rgba(156, 39, 176, 0.4); }

        .dash-icon {
            font-size: 3.5rem; margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(213, 0, 249, 0.6);
            transform: translateZ(30px); transition: transform 0.3s;
        }
        
        .dash-title {
            font-size: 1.3rem; font-weight: bold; color: #fff;
            transform: translateZ(20px); transition: color 0.3s;
        }
        .dash-card:active { transform: scale(0.95) !important; }

        /* --- TRANSICIONES DE VISTAS --- */
        .tab-content { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .tab-content.display-block { display: block; }
        .tab-content.visible { opacity: 1; transform: translateY(0); }

        /* --- FORMULARIOS --- */
        input, select {
            width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box;
            border-radius: 8px; font-size: 16px;
            background-color: rgba(0, 0, 0, 0.5); border: 1px solid #4a148c; color: #fff; outline: none;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: #d500f9; box-shadow: 0 0 8px rgba(213, 0, 249, 0.3); }

        button {
            width: 100%; padding: 14px; margin-top: 10px;
            border: none; border-radius: 8px; font-weight: bold; font-size: 16px; 
            cursor: pointer; color: white;
            background: linear-gradient(90deg, #6a0dad, #9c27b0);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover { box-shadow: 0 0 15px rgba(156, 39, 176, 0.6); }
        button:active { transform: scale(0.96); }
        
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-action { margin: 0; font-size: 0.85rem; padding: 10px; }
        .btn-full { grid-column: span 2; } 
        .btn-excel { background: #2e7d32; }
        .btn-email { background: #1565c0; }
        .btn-print { background: #ef6c00; }

        /* --- TABLAS --- */
        .tabla-container { overflow-x: auto; border-radius: 8px; border: 1px solid #444; margin-top: 15px;}
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; }
        th { background: #1a0b2e; color: #ea80fc; position: sticky; top: 0; }
        tr:hover td { background: rgba(255, 255, 255, 0.05); }
        .prod-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 1px solid #d1b3ff; }

        /* --- LOGIN --- */
        #login-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
            padding: 20px; box-sizing: border-box;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            transition: opacity 0.5s ease;
        }
        .login-inner { max-width: 350px; animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{ transform: scale(0.8); opacity: 0; } to{ transform: scale(1); opacity: 1; } }

        /* --- SLIDER --- */
        .slider-wrapper {
            width: 100%; border-radius: 12px; overflow: hidden;
            box-shadow: 0 0 15px rgba(106, 13, 173, 0.5); background: #000;
            aspect-ratio: 16/9; position: relative; z-index: 10; margin-top: 20px;
        }
        .slider-track { display: flex; width: 400%; animation: slideAnimation 16s infinite; height: 100%; }
        .slide-img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes slideAnimation {
            0%, 20% { margin-left: 0; } 25%, 45% { margin-left: -100%; }
            50%, 70% { margin-left: -200%; } 75%, 95% { margin-left: -300%; } 100% { margin-left: 0; }
        }

        .footer-credit { text-align: center; font-size: 0.7em; color: #777; margin-top: 20px; width: 100%; }

        /* --- RESPONSIVE (M√≥viles) --- */
        @media (max-width: 768px) {
            #app-view { flex-direction: column; }
            .mobile-header { display: flex; }
            
            .sidebar {
                position: fixed; top: 0; left: -280px; /* Oculto a la izquierda */
                height: 100%; width: 280px;
                box-shadow: 5px 0 15px rgba(0,0,0,0.8);
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar.active { left: 0; } /* Mostrar men√∫ */
            
            /* Capa oscura cuando el men√∫ est√° abierto en m√≥vil */
            .sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 99; backdrop-filter: blur(2px);
            }
            .sidebar-overlay.active { display: block; }
        }

        /* --- IMPRESI√ìN --- */
        @media print {
            .no-print, .sidebar, .mobile-header, #bg-container, #view-dashboard { display: none !important; }
            body, .seccion, #app-view, .main-content { background: white !important; color: black !important; margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; display: block !important;}
            .tab-content { display: none; }
            .tab-content.display-block { display: block; opacity: 1; transform: none; }
            table { width: 100%; border: 1px solid black; }
            th, td { border: 1px solid black; color: black; }
            #titulo-impresion { display: block !important; text-align: center; margin-bottom: 20px; }
        }
        #titulo-impresion { display: none; }
    </style>
</head>
<body class="not-logged-in">

    <!-- FONDO ANIMADO -->
    <div id="bg-container"></div>

    <!-- 1. LOGIN -->
    <div id="login-view">
        <div class="login-box login-inner">
            <h2 style="border:none; text-align:center; font-size: 2em; text-shadow: 0 0 10px #aa00ff; margin: 0 0 20px 0;">ALP 13</h2>
            <div id="form-login">
                <input type="text" id="log_user" placeholder="Usuario">
                <input type="password" id="log_pass" placeholder="Contrase√±a">
                <button onclick="iniciarSesion()">INGRESAR</button>
                <button class="btn-link" style="background:none; border:none; color:#d1b3ff; text-decoration:underline; font-size:0.9em; margin-top:10px;" onclick="toggleRegistro()">Crear cuenta</button>
                <p id="error_msg" style="color:red; display:none; text-align:center; margin-top: 10px;">Datos incorrectos</p>
            </div>
            <div id="form-register" style="display:none;">
                <h3 style="border:none; color:white; text-align:center;">Registro</h3>
                <input type="text" id="reg_user" placeholder="Nuevo Usuario">
                <input type="password" id="reg_pass" placeholder="Nueva Contrase√±a">
                <button onclick="registrarUsuario()" style="background: linear-gradient(90deg, #00c853, #64dd17);">REGISTRARSE</button>
                <button class="btn-link" style="background:none; border:none; color:#d1b3ff; margin-top:10px;" onclick="toggleRegistro()">Volver</button>
                <p id="reg_msg" style="color:#00e676; display:none; text-align:center; margin-top: 10px;">Usuario creado</p>
            </div>
        </div>
        <div class="footer-credit" style="position:fixed; bottom:10px;">DEV - ROBERT PARACO 2025</div>
    </div>

    <!-- 2. APP PRINCIPAL -->
    <!-- Overlay para m√≥vil -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Cabecera M√≥vil (Solo visible < 768px) -->
    <div class="mobile-header" id="mobileHeader" style="display:none;">
        <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
        <span style="font-weight:bold; color:#d1b3ff; letter-spacing:1px;">ALP 13</span>
        <span style="width:24px;"></span> <!-- Espaciador para centrar -->
    </div>

    <div id="app-view">
        
        <!-- SIDEBAR (MEN√ö LATERAL) -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="sidebar-title">ALP 13</h1>
                <small style="color:#777;">Inventario Pro</small>
            </div>
            
            <div class="nav-links">
                <div class="nav-btn active" id="btn-dashboard" onclick="navegar('view-dashboard', 'Inicio', this)">
                    <span>üè†</span> Inicio
                </div>
                <div class="nav-btn" id="btn-inventario" onclick="navegar('view-inventario', 'Inventario', this)">
                    <span>üìã</span> Inventario
                </div>
                <div class="nav-btn" id="btn-movimientos" onclick="navegar('view-movimientos', 'Movimientos', this)">
                    <span>üîÑ</span> Movimientos
                </div>
                <div class="nav-btn" id="btn-reportes" onclick="navegar('view-reportes', 'Reportes', this)">
                    <span>üìä</span> Reportes
                </div>
            </div>

            <div class="btn-logout" onclick="cerrarSesion()">
                Cerrar Sesi√≥n
            </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="main-content">
            
            <!-- VISTA 0: DASHBOARD 3D -->
            <div id="view-dashboard" class="tab-content display-block visible">
                <div class="dashboard-container">
                    <h2 style="border:none; margin-bottom:10px;">Bienvenido</h2>
                    <p style="color:#aaa; margin-bottom:30px;">Panel de control general</p>
                    
                    <div class="dash-grid">
                        <div class="dash-card" onclick="irA('view-inventario', 'Inventario', 'btn-inventario')">
                            <span class="dash-icon">üìã</span>
                            <div class="dash-title">Inventario</div>
                        </div>
                        <div class="dash-card" onclick="irA('view-movimientos', 'Movimientos', 'btn-movimientos')">
                            <span class="dash-icon">üîÑ</span>
                            <div class="dash-title">Movimientos</div>
                        </div>
                        <div class="dash-card" onclick="irA('view-reportes', 'Reportes', 'btn-reportes')">
                            <span class="dash-icon">üìä</span>
                            <div class="dash-title">Reportes</div>
                        </div>
                    </div>

                    <!-- SLIDER IM√ÅGENES -->
                    <div class="seccion no-print" style="margin-top:40px;">
                        <h3 style="text-align:center; border:none;">ApexGen BR</h3>
                        <div class="slider-wrapper">
                            <div class="slider-track">
                                <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-1.png" class="slide-img">
                                <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-2.png" class="slide-img">
                                <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-3.png" class="slide-img">
                                <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-4.png" class="slide-img">
                            </div>
                        </div>
                    </div>
                    <div class="footer-credit no-print">DEVELOPER - ROBERT PARACO 2025</div>
                </div>
            </div>

            <!-- VISTA 1: INVENTARIO -->
            <div id="view-inventario" class="tab-content">
                <h2>Gesti√≥n de Inventario</h2>
                <div class="seccion no-print">
                    <h3>+ Nuevo Producto</h3>
                    <input type="text" id="inp_codigo" placeholder="C√≥digo (ej. A01)">
                    <input type="text" id="inp_nombre" placeholder="Nombre Producto">
                    <input type="text" id="inp_ubicacion" placeholder="Ubicaci√≥n">
                    <input type="number" id="inp_saldo" placeholder="Cantidad Inicial">
                    <label style="color:#aaa; font-size:0.9em;">Foto (Opcional):</label>
                    <input type="file" id="inp_foto" accept="image/*">
                    <button onclick="agregarProducto()">GUARDAR</button>
                </div>

                <div class="seccion">
                    <h3>üîç Lista de Productos</h3>
                    <input type="text" id="inp_buscar" onkeyup="buscarProducto()" placeholder="Escribe nombre o c√≥digo...">
                    <div class="tabla-container">
                        <table>
                            <thead>
                                <tr><th>Img</th><th>Info</th><th>Stock</th><th>Acci√≥n</th></tr>
                            </thead>
                            <tbody id="tablaProductos"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VISTA 2: MOVIMIENTOS -->
            <div id="view-movimientos" class="tab-content">
                <h2>Entradas y Salidas</h2>
                <div class="seccion">
                    <h3>Registrar Movimiento</h3>
                    <label style="color:#d1b3ff; font-size:0.9em;">Producto:</label>
                    <select id="sel_movProd_input"></select>
                    <div style="display:flex; gap:10px;">
                        <select id="sel_tipo" style="flex:1;">
                            <option value="ENTRADA">üü¢ Entrada</option>
                            <option value="SALIDA">üî¥ Salida</option>
                        </select>
                        <input type="number" id="inp_cantidad" placeholder="Cant." style="flex:1;">
                    </div>
                    <input type="text" id="inp_referencia" placeholder="Referencia / Nota">
                    <button onclick="agregarMovimiento()">CONFIRMAR</button>
                </div>
            </div>

            <!-- VISTA 3: REPORTES -->
            <div id="view-reportes" class="tab-content">
                <h2 class="no-print">Reportes</h2>
                <div class="seccion">
                    <h3 class="no-print">Historial de Transacciones</h3>
                    <h2 id="titulo-impresion">Reporte de Inventario</h2>
                    <div class="no-print" style="margin-bottom:15px;">
                        <select id="sel_movProd" onchange="mostrarMovPorProducto()"></select>
                    </div>
                    <div class="action-buttons no-print">
                        <button class="btn-action btn-excel" onclick="exportarExcel()">Excel</button>
                        <button class="btn-action btn-email" onclick="enviarCorreo()">Email</button>
                        <button class="btn-action btn-print btn-full" onclick="imprimirSeleccion()">Imprimir Reporte</button>
                    </div>
                    <div class="tabla-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="no-print">‚úî</th>
                                    <th>Prod.</th>
                                    <th>Tipo</th>
                                    <th>Cant</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="tablaMovProd"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>
    // --- 1. INICIALIZACI√ìN ---
    window.addEventListener('DOMContentLoaded', () => {
        initUsuarios();
        crearFondoAnimado();
        iniciarEfecto3D();
        checkMobileDisplay();
    });

    window.addEventListener('resize', checkMobileDisplay);

    function checkMobileDisplay() {
        const mh = document.getElementById('mobileHeader');
        if(window.innerWidth <= 768 && document.body.classList.contains('logged-in')) {
            mh.style.display = 'flex';
        } else {
            mh.style.display = 'none';
        }
    }

    // --- 2. SCRIPT DE MOVIMIENTO 3D ---
    function iniciarEfecto3D() {
        const cards = document.querySelectorAll('.dash-card');
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left; 
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = ((y - centerY) / centerY) * -20; 
                const rotateY = ((x - centerX) / centerX) * 20;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg)`;
            });
            card.addEventListener('mousedown', () => {
                 card.style.transform = `perspective(1000px) scale(0.95)`;
            });
        });
    }

    // --- 3. FONDO ANIMADO ---
    function crearFondoAnimado() {
        const bg = document.getElementById("bg-container");
        const chars = ['0', '1', '10', '01', '‚àë', 'œÄ', '‚à´', '‚àÜ', 'Œ©', 'Œ≤', 'Œª', '{ }', '</>', '0xFF'];
        for(let i=0; i<35; i++) {
            let el = document.createElement('div');
            el.className = 'floating-graphic';
            el.innerText = chars[Math.floor(Math.random() * chars.length)];
            el.style.left = Math.random() * 100 + 'vw';
            el.style.fontSize = (Math.random() * 35 + 15) + 'px'; 
            el.style.animationDuration = (Math.random() * 12 + 6) + 's'; 
            el.style.animationDelay = (Math.random() * 10) + 's';
            bg.appendChild(el);
        }
    }

    // --- 4. L√ìGICA DE NAVEGACI√ìN (MODIFICADA PARA SIDEBAR) ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function irA(vistaId, nombreVista, btnId) {
        navegar(vistaId, nombreVista, document.getElementById(btnId));
    }

    function navegar(vistaId, nombreVista, btnElement) {
        // Cerrar men√∫ si estamos en m√≥vil
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').classList.remove('active');
        }

        // Botones activos
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        const vistaActual = document.querySelector('.tab-content.visible');
        const vistaNueva = document.getElementById(vistaId);

        if (vistaActual === vistaNueva) return;

        if(vistaActual) {
            vistaActual.classList.remove('visible');
            setTimeout(() => {
                vistaActual.classList.remove('display-block');
                vistaNueva.classList.add('display-block');
                setTimeout(() => {
                    vistaNueva.classList.add('visible');
                }, 50);
                if(vistaId !== 'view-dashboard') actualizarTodo();
            }, 400); 
        } else {
            vistaNueva.classList.add('display-block', 'visible');
        }
    }

    // --- 5. USUARIOS Y LOGIN ---
    function initUsuarios() {
        if(!localStorage.getItem("alp13_users")) {
            localStorage.setItem("alp13_users", JSON.stringify([{user:"admin", pass:"1234"}]));
        }
    }

    function toggleRegistro() {
        const login = document.getElementById("form-login");
        const reg = document.getElementById("form-register");
        if (login.style.display === "none") {
            login.style.display = "block"; reg.style.display = "none";
        } else {
            login.style.display = "none"; reg.style.display = "block";
        }
        document.getElementById("error_msg").style.display = "none";
        document.getElementById("reg_msg").style.display = "none";
    }

    function registrarUsuario() {
        const u = document.getElementById("reg_user").value.trim();
        const p = document.getElementById("reg_pass").value.trim();
        if(!u || !p) return alert("Faltan datos");

        let users = JSON.parse(localStorage.getItem("alp13_users")) || [];
        if(users.some(x => x.user === u)) return alert("Usuario existe");

        users.push({user: u, pass: p});
        localStorage.setItem("alp13_users", JSON.stringify(users));
        
        const msg = document.getElementById("reg_msg");
        msg.innerText = "¬°Usuario Creado!";
        msg.style.display = "block";
        setTimeout(() => toggleRegistro(), 1500);
    }

    function iniciarSesion() {
        const u = document.getElementById("log_user").value.trim();
        const p = document.getElementById("log_pass").value.trim();
        let users = JSON.parse(localStorage.getItem("alp13_users")) || [];
        
        if(users.some(x => x.user === u && x.pass === p)) {
            alert(u.toUpperCase() + " BETICO Y ROBERT DEVELOPER TE DAN LA BIENVENIDA");

            document.getElementById("login-view").style.display = "none";
            document.body.classList.remove('not-logged-in');
            document.body.classList.add('logged-in');
            
            // Mostrar App
            const app = document.getElementById("app-view");
            app.style.display = "flex"; 
            
            checkMobileDisplay();
            navegar('view-dashboard', 'Inicio', document.getElementById('btn-dashboard'));
            actualizarTodo();
        } else {
            document.getElementById("error_msg").style.display = "block";
        }
    }

    function cerrarSesion() {
        alert("PROGRAMADOR - ROBERT PARACO 2025");
        location.reload(); 
    }

    // --- 6. SISTEMA CRUD ---
    let productos = JSON.parse(localStorage.getItem("alp13_productos")) || [];
    let movimientos = JSON.parse(localStorage.getItem("alp13_mov")) || [];

    const getBase64 = (file) => new Promise((resolve,reject) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = () => resolve(r.result); r.onerror = error => reject(error);
    });

    async function agregarProducto() {
        const cod = document.getElementById("inp_codigo").value;
        const nom = document.getElementById("inp_nombre").value;
        const ubi = document.getElementById("inp_ubicacion").value;
        const sal = parseInt(document.getElementById("inp_saldo").value) || 0;
        const file = document.getElementById("inp_foto");

        if(!cod || !nom) return alert("C√≥digo y Nombre requeridos");

        let foto = "https://via.placeholder.com/50/4a148c/ffffff?text=IMG";
        if(file.files.length > 0) {
            try { foto = await getBase64(file.files[0]); } catch(e){}
        }

        const dataQR = `ID:${cod}|Pr:${nom}|Ub:${ubi}|St:${sal}`;
        const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(dataQR)}`;

        productos.push({ codigo:cod, nombre:nom, ubicacion:ubi, saldo:sal, foto:foto, qr:qr });
        productos.sort((a,b)=> a.nombre.localeCompare(b.nombre));
        
        guardar();
        document.getElementById("inp_codigo").value = "";
        document.getElementById("inp_nombre").value = "";
        document.getElementById("inp_ubicacion").value = "";
        document.getElementById("inp_saldo").value = "";
        document.getElementById("inp_foto").value = "";
        
        alert("Producto Guardado");
        mostrar();
    }

    function agregarMovimiento() {
        const prodName = document.getElementById("sel_movProd_input").value;
        const tipo = document.getElementById("sel_tipo").value;
        const cant = parseInt(document.getElementById("inp_cantidad").value);
        const ref = document.getElementById("inp_referencia").value || "-";

        if(!prodName || !cant) return alert("Faltan datos");

        let idx = productos.findIndex(p => p.nombre === prodName);
        if(idx === -1) return;

        if(tipo === "ENTRADA") productos[idx].saldo += cant;
        else {
            if(productos[idx].saldo < cant) return alert("Stock insuficiente");
            productos[idx].saldo -= cant;
        }

        let p = productos[idx];
        const dataQR = `ID:${p.codigo}|Pr:${p.nombre}|Ub:${p.ubicacion}|St:${p.saldo}`;
        p.qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(dataQR)}`;

        movimientos.push({ producto:prodName, tipo:tipo, cantidad:cant, referencia:ref, fecha: new Date().toLocaleString() });
        
        guardar();
        document.getElementById("inp_cantidad").value = "";
        document.getElementById("inp_referencia").value = "";
        alert("Movimiento Registrado");
    }

    function borrarProducto(idx) {
        if(confirm("¬øBorrar producto?")) {
            productos.splice(idx,1);
            guardar();
        }
    }

    function guardar() {
        localStorage.setItem("alp13_productos", JSON.stringify(productos));
        localStorage.setItem("alp13_mov", JSON.stringify(movimientos));
        actualizarTodo();
    }

    function mostrar(lista = productos) {
        const t = document.getElementById("tablaProductos");
        t.innerHTML = "";
        if(lista.length === 0) { t.innerHTML = "<tr><td colspan='4'>Vac√≠o</td></tr>"; return; }

        lista.forEach(p => {
            let realIdx = productos.findIndex(x => x.nombre === p.nombre);
            t.innerHTML += `
            <tr>
                <td><img src="${p.foto}" class="prod-img"></td>
                <td>
                    <b style="color:white;">${p.nombre}</b><br>
                    <small style="color:#aaa;">ID:${p.codigo}</small><br>
                    <small style="color:#d1b3ff;">${p.ubicacion}</small>
                </td>
                <td style="font-weight:bold; color:#00e676; font-size:1.1em;">${p.saldo}</td>
                <td>
                    <button onclick="borrarProducto(${realIdx})" style="padding:5px; width:auto; background:#d32f2f;">üóë</button>
                    <a href="${p.qr}" download target="_blank"><img src="${p.qr}" style="width:30px; margin-left:5px;"></a>
                </td>
            </tr>`;
        });
    }

    function buscarProducto() {
        const val = document.getElementById("inp_buscar").value.toLowerCase();
        const f = productos.filter(p => p.nombre.toLowerCase().includes(val) || p.codigo.toLowerCase().includes(val));
        mostrar(f);
    }

    function mostrarMovPorProducto() {
        const filter = document.getElementById("sel_movProd").value;
        const t = document.getElementById("tablaMovProd");
        t.innerHTML = "";

        let data = movimientos.slice().reverse();
        if(filter && filter !== "TODOS") data = data.filter(m => m.producto === filter);

        if(data.length === 0) { t.innerHTML = "<tr><td colspan='5'>Sin movimientos</td></tr>"; return; }

        data.forEach((m, i) => {
            let col = m.tipo === "ENTRADA" ? "#00e676" : "#ff1744";
            t.innerHTML += `
            <tr>
                <td class="no-print"><input type="checkbox" class="chk-print"></td>
                <td>${m.producto}<br><small style="color:#aaa">${m.referencia}</small></td>
                <td style="color:${col}; font-weight:bold;">${m.tipo.substring(0,3)}</td>
                <td style="font-weight:bold;">${m.cantidad}</td>
                <td style="font-size:0.75em; color:#bbb;">${m.fecha.split(',')[0]}</td>
            </tr>`;
        });
    }

    function cargarSelects() {
        const s1 = document.getElementById("sel_movProd");
        const s2 = document.getElementById("sel_movProd_input");
        const v1 = s1.value, v2 = s2.value;
        let ops = productos.map(p => `<option value="${p.nombre}">${p.nombre}</option>`).join('');
        s1.innerHTML = `<option value="TODOS">Todo</option>` + ops;
        s2.innerHTML = ops;
        if(v1) s1.value = v1;
        if(v2) s2.value = v2;
    }

    function actualizarTodo() {
        cargarSelects(); mostrar(); mostrarMovPorProducto();
    }

    function getSelected() {
        const chks = document.querySelectorAll('.chk-print:checked');
        let rows = chks.length ? Array.from(chks).map(c=>c.closest('tr')) : Array.from(document.querySelectorAll('#tablaMovProd tr'));
        return rows.map(r => {
            let d = r.querySelectorAll('td');
            if(!d.length) return null;
            return [d[1].innerText, d[2].innerText, d[3].innerText, d[4].innerText].join(',');
        }).filter(x=>x);
    }

    function exportarExcel() {
        const csv = "Producto/Ref,Tipo,Cant,Fecha\n" + getSelected().join('\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        a.download = 'reporte_alp13.csv';
        a.click();
    }

    function enviarCorreo() {
        const body = getSelected().join('%0D%0A');
        window.location.href = `mailto:?subject=Reporte ALP13&body=${body}`;
    }

    function imprimirSeleccion() {
        const chks = document.querySelectorAll('.chk-print');
        const hasCheck = Array.from(chks).some(c => c.checked);
        if(hasCheck) chks.forEach(c => { if(!c.checked) c.closest('tr').classList.add('no-print'); });
        window.print();
        if(hasCheck) chks.forEach(c => c.closest('tr').classList.remove('no-print'));
    }
</script>
</body>
</html>
