<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="https://i.ibb.co/bRgBcNkd/a-bold-logo-design-featuring-the-letters-em-SC-r-FBQ4-O6y0-WUPQAUu-A-ay-N6fa2-SQF6-Pw-O1r-KAR9-FA.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALP 13 Inventario Pro - Online</title>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Segoe UI', sans-serif; 
            color: #e0e0e0; 
            background-color: #000;
            overflow-x: hidden;
            position: relative;
        }
        body { background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); }
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 0; pointer-events: none; }
        .floating-graphic { position: absolute; color: rgba(187, 134, 252, 0.25); font-family: 'Courier New', monospace; font-weight: bold; user-select: none; text-shadow: 0 0 10px rgba(187, 134, 252, 0.5); animation: floatUp linear infinite; bottom: -100px; }
        @keyframes floatUp { 0% { transform: translateY(100vh) rotate(0deg) scale(0.8); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-20vh) rotate(360deg) scale(1.2); opacity: 0; } }
        
        .login-box, .seccion, .nav-container, .header-bar, .dashboard-container { position: relative; z-index: 10; }
        .login-box, .seccion { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6); padding: 20px; margin-bottom: 20px; width: 100%; box-sizing: border-box; transition: all 0.3s ease; }
        #app-view { display: none; padding: 10px; width: 100%; max-width: 800px; margin: 0 auto; box-sizing: border-box; }
        h2, h3 { color: #d1b3ff; border-bottom: 1px solid #4a148c; padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-size: 1.2rem; }
        
        /* DASHBOARD 3D */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 10px; perspective: 1000px; }
        .dash-card { background: linear-gradient(135deg, rgba(74, 20, 140, 0.8), rgba(10, 10, 10, 0.95)); border: 1px solid #7b1fa2; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform-style: preserve-3d; transform: rotateX(0deg) rotateY(0deg); transition: transform 0.1s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; }
        .dash-card:hover { border-color: #d500f9; box-shadow: 0 20px 40px rgba(156, 39, 176, 0.4); }
        .dash-icon { font-size: 3rem; margin-bottom: 10px; text-shadow: 0 0 15px rgba(213, 0, 249, 0.6); transform: translateZ(30px); transition: transform 0.3s; }
        .dash-title { font-size: 1.1rem; font-weight: bold; color: #fff; transform: translateZ(20px); }
        .dash-card:active { transform: scale(0.95) !important; }

        /* GALERIA ESTILOS */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .gallery-card { background: rgba(0,0,0,0.6); border: 1px solid #4a148c; border-radius: 10px; overflow: hidden; transition: 0.3s; }
        .gallery-card:hover { border-color: #00e676; transform: translateY(-5px); }
        .gallery-main-img { width: 100%; height: 200px; object-fit: cover; border-bottom: 1px solid #444; cursor: pointer; }
        .gallery-thumbs { display: flex; height: 60px; background: #111; }
        .gallery-thumb { flex: 1; object-fit: cover; border-right: 1px solid #333; cursor: pointer; opacity: 0.7; transition: 0.2s; }
        .gallery-thumb:hover { opacity: 1; border: 1px solid #fff; }
        .gallery-info { padding: 15px; }
        .gallery-info h4 { margin: 0 0 5px 0; color: #fff; font-size: 1.2em; }
        .gallery-info p { margin: 3px 0; font-size: 0.9em; color: #aaa; }
        .gallery-label { color: #d1b3ff; font-weight: bold; }

        /* NAV */
        .nav-toggle { background: linear-gradient(90deg, #4a148c, #7b1fa2); color: white; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border: 1px solid #9c27b0; user-select: none; box-shadow: 0 0 10px rgba(123, 31, 162, 0.5); }
        .nav-menu { display: none; background: rgba(30, 10, 50, 0.95); border: 1px solid #6a0dad; border-top: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; overflow: hidden; position: absolute; width: 100%; box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 100; }
        .nav-menu.show { display: block; animation: slideDown 0.3s ease-out; }
        .nav-btn { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #d1b3ff; cursor: pointer; transition: 0.3s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 25px; }
        .nav-btn.active { color: #00e676; font-weight: bold; border-left: 4px solid #00e676; background: rgba(0, 230, 118, 0.1); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* UTILS */
        .tab-content { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
        .tab-content.display-block { display: block; }
        .tab-content.visible { opacity: 1; transform: translateY(0); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; border-radius: 8px; font-size: 16px; background-color: rgba(0, 0, 0, 0.5); border: 1px solid #4a148c; color: #fff; outline: none; transition: border-color 0.3s; }
        input[type="file"] { font-size: 12px; }
        input:focus, select:focus { border-color: #d500f9; box-shadow: 0 0 8px rgba(213, 0, 249, 0.3); }
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; color: white; background: linear-gradient(90deg, #6a0dad, #9c27b0); transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { box-shadow: 0 0 15px rgba(156, 39, 176, 0.6); }
        button:active { transform: scale(0.96); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-logout { width: auto; background: #333; padding: 8px 12px; font-size: 0.8rem; margin: 0; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .btn-action { margin: 0; font-size: 0.85rem; padding: 10px; }
        .btn-full { grid-column: span 2; } 
        .btn-excel { background: #2e7d32; }
        .btn-email { background: #1565c0; }
        .btn-print { background: #ef6c00; }

        /* TABLE */
        .tabla-container { overflow-x: auto; border-radius: 8px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; transition: background 0.2s; }
        th { background: #1a0b2e; color: #ea80fc; position: sticky; top: 0; }
        tr:hover td { background: rgba(255, 255, 255, 0.05); }
        .prod-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 1px solid #d1b3ff; }

        /* LOGIN & SLIDER */
        #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; background: rgba(0,0,0,0.6); transition: opacity 0.5s ease; }
        .login-inner { max-width: 350px; animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{ transform: scale(0.8); opacity: 0; } to{ transform: scale(1); opacity: 1; } }
        .slider-wrapper { width: 100%; border-radius: 12px; overflow: hidden; box-shadow: 0 0 15px rgba(106, 13, 173, 0.5); background: #000; aspect-ratio: 16/9; position: relative; z-index: 10; }
        .slider-track { display: flex; width: 400%; animation: slideAnimation 16s infinite; height: 100%; }
        .slide-img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes slideAnimation { 0%, 20% { margin-left: 0; } 25%, 45% { margin-left: -100%; } 50%, 70% { margin-left: -200%; } 75%, 95% { margin-left: -300%; } 100% { margin-left: 0; } }
        .footer-credit { text-align: center; font-size: 0.7em; color: #777; margin-top: 20px; width: 100%; position: relative; z-index: 10; }

        @media print {
            .no-print, .nav-container, .header-bar button, #bg-container, #view-dashboard { display: none !important; }
            body, .seccion { background: white !important; color: black !important; box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; }
            #app-view { display: block !important; width: 100% !important; max-width: none !important; }
            .tab-content { display: none; }
            .tab-content.display-block { display: block; opacity: 1; transform: none; }
            table { width: 100%; border: 1px solid black; }
            th, td { border: 1px solid black; color: black; }
            #titulo-impresion { display: block !important; text-align: center; margin-bottom: 20px; }
        }
        #titulo-impresion { display: none; }
    </style>
</head>
<body>

    <div id="bg-container"></div>

    <!-- 1. LOGIN -->
    <div id="login-view">
        <div class="login-box login-inner">
            <h2 style="border:none; text-align:center; font-size: 2em; text-shadow: 0 0 10px #aa00ff; margin: 0 0 20px 0;">ALP 13</h2>
            <div id="form-login">
                <input type="text" id="log_user" placeholder="Usuario">
                <input type="password" id="log_pass" placeholder="Contrase√±a">
                <button onclick="iniciarSesion()">INGRESAR</button>
                <button class="btn-link" style="background:none; border:none; color:#d1b3ff; text-decoration:underline; font-size:0.9em; margin-top:10px;" onclick="toggleRegistro()">Crear cuenta</button>
                <p id="error_msg" style="color:red; display:none; text-align:center; margin-top: 10px;">Datos incorrectos</p>
                <p id="loading_msg" style="color:#00e676; display:none; text-align:center;">Conectando...</p>
            </div>
            <div id="form-register" style="display:none;">
                <h3 style="border:none; color:white; text-align:center;">Registro</h3>
                <input type="text" id="reg_user" placeholder="Nuevo Usuario">
                <input type="password" id="reg_pass" placeholder="Nueva Contrase√±a">
                <button onclick="registrarUsuario()" style="background: linear-gradient(90deg, #00c853, #64dd17);">REGISTRARSE</button>
                <button class="btn-link" style="background:none; border:none; color:#d1b3ff; margin-top:10px;" onclick="toggleRegistro()">Volver</button>
                <p id="reg_msg" style="color:#00e676; display:none; text-align:center; margin-top: 10px;">Usuario creado</p>
            </div>
        </div>
        <div class="footer-credit" style="position:fixed; bottom:10px;">DEV - ROBERT PARACO 2025</div>
    </div>

    <!-- 2. APP PRINCIPAL -->
    <div id="app-view">
        <div class="header-bar">
            <h2 style="margin:0; font-size:1.5rem;">üì¶ ALP 13 <span style="font-size:0.6em; color:#00e676;">‚óè ONLINE</span></h2>
            <button class="btn-logout" onclick="cerrarSesion()">Salir</button>
        </div>

        <div class="nav-container no-print">
            <div class="nav-toggle" onclick="toggleMenu()">
                <span id="menu-title">‚ò∞ INICIO</span>
                <span>‚ñº</span>
            </div>
            <div class="nav-menu" id="navMenu">
                <div class="nav-btn" id="btn-dashboard" onclick="navegar('view-dashboard', 'Inicio', this)">üè† Inicio</div>
                <div class="nav-btn" id="btn-galeria" onclick="navegar('view-galeria', 'Galer√≠a', this)">üì∑ Galer√≠a</div>
                <div class="nav-btn" id="btn-inventario" onclick="navegar('view-inventario', 'Inventario', this)">üìã Inventario (Tabla)</div>
                <div class="nav-btn" id="btn-movimientos" onclick="navegar('view-movimientos', 'Movimientos', this)">üîÑ Registrar Movimiento</div>
                <div class="nav-btn" id="btn-reportes" onclick="navegar('view-reportes', 'Reportes', this)">üìä Reportes e Historial</div>
            </div>
        </div>

        <div id="view-dashboard" class="tab-content display-block visible">
            <div class="dashboard-container">
                <h3 style="text-align:center; border:none; margin-bottom:20px;">Selecciona una opci√≥n</h3>
                <div class="dash-grid">
                    <div class="dash-card" onclick="irA('view-galeria', 'Galer√≠a', 'btn-galeria')">
                        <span class="dash-icon">üì∑</span>
                        <div class="dash-title">Galer√≠a</div>
                    </div>
                    <div class="dash-card" onclick="irA('view-inventario', 'Inventario', 'btn-inventario')">
                        <span class="dash-icon">üìã</span>
                        <div class="dash-title">Inventario</div>
                    </div>
                    <div class="dash-card" onclick="irA('view-movimientos', 'Movimientos', 'btn-movimientos')">
                        <span class="dash-icon">üîÑ</span>
                        <div class="dash-title">Movimientos</div>
                    </div>
                    <div class="dash-card" onclick="irA('view-reportes', 'Reportes', 'btn-reportes')">
                        <span class="dash-icon">üìä</span>
                        <div class="dash-title">Reportes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NUEVA VISTA DE GALERIA -->
        <div id="view-galeria" class="tab-content">
            <div class="seccion">
                <h3>üì∑ Galer√≠a de Productos</h3>
                <input type="text" id="inp_buscar_gal" onkeyup="renderizarGaleria()" placeholder="Buscar en galer√≠a...">
                <div class="gallery-grid" id="galeria-container">
                    <!-- AQUI SE GENERAN LAS TARJETAS -->
                </div>
            </div>
        </div>

        <div id="view-inventario" class="tab-content">
            <div class="seccion no-print">
                <h3>+ Nuevo Producto (Con 4 Fotos)</h3>
                <input type="text" id="inp_codigo" placeholder="C√≥digo (ej. A01)">
                <input type="text" id="inp_nombre" placeholder="Nombre Producto">
                <input type="text" id="inp_ubicacion" placeholder="Ubicaci√≥n">
                <input type="number" id="inp_saldo" placeholder="Cantidad Inicial">
                
                <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-top:10px;">
                    <label style="color:#aaa; font-size:0.9em; display:block; margin-bottom:5px;">Subir 4 Fotos:</label>
                    <input type="file" id="inp_foto1" accept="image/*" placeholder="Foto 1 (Principal)">
                    <input type="file" id="inp_foto2" accept="image/*" placeholder="Foto 2">
                    <input type="file" id="inp_foto3" accept="image/*" placeholder="Foto 3">
                    <input type="file" id="inp_foto4" accept="image/*" placeholder="Foto 4">
                </div>

                <button onclick="agregarProducto()">GUARDAR EN NUBE</button>
            </div>

            <div class="seccion">
                <h3>üîç Inventario (Tabla)</h3>
                <input type="text" id="inp_buscar" onkeyup="buscarProducto()" placeholder="Escribe nombre o c√≥digo...">
                <div class="tabla-container">
                    <table>
                        <thead>
                            <tr><th>Img</th><th>Info</th><th>Stock</th><th>Acci√≥n</th></tr>
                        </thead>
                        <tbody id="tablaProductos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-movimientos" class="tab-content">
            <div class="seccion">
                <h3>Registrar E/S</h3>
                <label style="color:#d1b3ff; font-size:0.9em;">Producto:</label>
                <select id="sel_movProd_input"></select>
                <div style="display:flex; gap:10px;">
                    <select id="sel_tipo" style="flex:1;">
                        <option value="ENTRADA">üü¢ Entrada</option>
                        <option value="SALIDA">üî¥ Salida</option>
                    </select>
                    <input type="number" id="inp_cantidad" placeholder="Cant." style="flex:1;">
                </div>
                <input type="text" id="inp_referencia" placeholder="Referencia / Nota">
                <button onclick="agregarMovimiento()">CONFIRMAR</button>
            </div>
        </div>

        <div id="view-reportes" class="tab-content">
            <div class="seccion">
                <h3 class="no-print">Historial (Tiempo Real)</h3>
                <h2 id="titulo-impresion">Reporte de Inventario</h2>
                <div class="no-print" style="margin-bottom:15px;">
                    <select id="sel_movProd" onchange="mostrarMovPorProducto()"></select>
                </div>
                <div class="action-buttons no-print">
                    <button class="btn-action btn-excel" onclick="exportarExcel()">Excel</button>
                    <button class="btn-action btn-email" onclick="enviarCorreo()">Email</button>
                    <button class="btn-action btn-print btn-full" onclick="imprimirSeleccion()">Imprimir Reporte</button>
                </div>
                <div class="tabla-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="no-print">‚úî</th>
                                <th>Prod.</th>
                                <th>Tipo</th>
                                <th>Cant</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMovProd"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="seccion no-print">
            <h3 style="text-align:center; border:none;">ApexGen BR</h3>
            <div class="slider-wrapper">
                <div class="slider-track">
                    <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-1.png" class="slide-img">
                    <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-2.png" class="slide-img">
                    <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-3.png" class="slide-img">
                    <img src="https://raw.githubusercontent.com/robertproductions12-developer/ALP-13/refs/heads/main/img-4.png" class="slide-img">
                </div>
            </div>
        </div>

        <div class="footer-credit no-print">DEVELOPER - ROBERT PARACO 2025</div>
    </div>

<script>
    // ***************************************************************
    // 1. CONFIGURACI√ìN DE FIREBASE (¬°REEMPLAZA AQU√ç!)
    // ***************************************************************
    
    // --- PEGA AQUI TU CONFIGURACION DE FIREBASE (DENTRO DE LAS LLAVES) ---
    const firebaseConfig = {
  apiKey: "AIzaSyCa6PgtZcQI0kjT71cgKGareZTXlHpaVpU",
  authDomain: "alp-13.firebaseapp.com",
  projectId: "alp-13",
  storageBucket: "alp-13.firebasestorage.app",
  messagingSenderId: "33740139606",
  appId: "1:33740139606:web:de35dc4ea46e1aabd49ff7"
    };
    // ----------------------------------------------------------------------

    // Inicializar Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase conectado");
    } catch (error) {
        console.error("Error Firebase:", error);
        alert("Error de conexi√≥n: Revisa la configuraci√≥n de Firebase en el c√≥digo.");
    }

    let productos = [];
    let movimientos = [];
    let usuarios = []; 
    const PLACEHOLDER = "https://via.placeholder.com/150/1a0b2e/ffffff?text=Sin+Foto";

    window.addEventListener('DOMContentLoaded', () => {
        crearFondoAnimado();
        iniciarEfecto3D();
        if(db) {
            escucharUsuarios();
            escucharProductos();
            escucharMovimientos();
        }
    });

    // --- FIREBASE LISTENERS ---
    function escucharUsuarios() {
        db.collection("usuarios").onSnapshot((querySnapshot) => {
            usuarios = [];
            querySnapshot.forEach((doc) => { usuarios.push(doc.data()); });
            if(usuarios.length === 0) usuarios.push({user:"admin", pass:"1234"});
        });
    }

    function escucharProductos() {
        db.collection("productos").onSnapshot((querySnapshot) => {
            productos = [];
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                data.id = doc.id;
                // Compatibilidad: si el producto viejo solo tiene 'foto' (singular), lo convertimos a array
                if(!data.fotos && data.foto) {
                    data.fotos = [data.foto, PLACEHOLDER, PLACEHOLDER, PLACEHOLDER];
                } else if (!data.fotos) {
                    data.fotos = [PLACEHOLDER, PLACEHOLDER, PLACEHOLDER, PLACEHOLDER];
                }
                productos.push(data);
            });
            productos.sort((a,b)=> a.nombre.localeCompare(b.nombre));
            actualizarTodo();
        });
    }

    function escucharMovimientos() {
        db.collection("movimientos").orderBy("timestamp", "desc").onSnapshot((querySnapshot) => {
            movimientos = [];
            querySnapshot.forEach((doc) => { movimientos.push(doc.data()); });
            actualizarTodo();
        });
    }

    // --- USUARIOS ---
    function toggleRegistro() {
        const login = document.getElementById("form-login");
        const reg = document.getElementById("form-register");
        login.style.display = (login.style.display === "none") ? "block" : "none";
        reg.style.display = (reg.style.display === "none") ? "block" : "none";
        document.getElementById("error_msg").style.display = "none";
        document.getElementById("reg_msg").style.display = "none";
    }
    function registrarUsuario() {
        const u = document.getElementById("reg_user").value.trim();
        const p = document.getElementById("reg_pass").value.trim();
        if(!u || !p) return alert("Faltan datos");
        if(usuarios.some(x => x.user === u)) return alert("Usuario ya existe");
        db.collection("usuarios").add({ user: u, pass: p }).then(() => {
            document.getElementById("reg_msg").style.display = "block";
            setTimeout(() => toggleRegistro(), 1500);
        }).catch(e => alert("Error: " + e.message));
    }
    function iniciarSesion() {
        const u = document.getElementById("log_user").value.trim();
        const p = document.getElementById("log_pass").value.trim();
        const loading = document.getElementById("loading_msg");
        loading.style.display = "block";
        setTimeout(() => {
            if(usuarios.some(x => x.user === u && x.pass === p)) {
                alert(u.toUpperCase() + " BIENVENIDO");
                document.getElementById("login-view").style.display = "none";
                document.getElementById("app-view").style.display = "block";
                navegar('view-dashboard', 'Inicio', document.getElementById('btn-dashboard'));
            } else {
                loading.style.display = "none";
                document.getElementById("error_msg").style.display = "block";
            }
        }, 1000);
    }
    function cerrarSesion() { location.reload(); }

    // --- LOGICA PRODUCTOS (CRUD) ---
    const getBase64 = (file) => new Promise((resolve,reject) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = () => resolve(r.result); r.onerror = error => reject(error);
    });

    async function agregarProducto() {
        const cod = document.getElementById("inp_codigo").value;
        const nom = document.getElementById("inp_nombre").value;
        const ubi = document.getElementById("inp_ubicacion").value;
        const sal = parseInt(document.getElementById("inp_saldo").value) || 0;
        
        // Obtener inputs de las 4 fotos
        const f1 = document.getElementById("inp_foto1").files[0];
        const f2 = document.getElementById("inp_foto2").files[0];
        const f3 = document.getElementById("inp_foto3").files[0];
        const f4 = document.getElementById("inp_foto4").files[0];

        if(!cod || !nom) return alert("C√≥digo y Nombre requeridos");

        // Procesar fotos a Base64
        let fotosArr = [PLACEHOLDER, PLACEHOLDER, PLACEHOLDER, PLACEHOLDER];
        
        try {
            if(f1) fotosArr[0] = await getBase64(f1);
            if(f2) fotosArr[1] = await getBase64(f2);
            if(f3) fotosArr[2] = await getBase64(f3);
            if(f4) fotosArr[3] = await getBase64(f4);
        } catch(e) { console.error(e); }

        const dataQR = `ID:${cod}|Pr:${nom}|Ub:${ubi}|St:${sal}`;
        const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(dataQR)}`;

        db.collection("productos").add({
            codigo: cod, nombre: nom, ubicacion: ubi, saldo: sal, 
            foto: fotosArr[0], // Guardamos la principal suelta por compatibilidad
            fotos: fotosArr,   // Guardamos el array completo
            qr: qr
        }).then(() => {
            alert("Producto Guardado con Fotos");
            document.getElementById("inp_codigo").value = "";
            document.getElementById("inp_nombre").value = "";
            document.getElementById("inp_ubicacion").value = "";
            document.getElementById("inp_saldo").value = "";
            document.getElementById("inp_foto1").value = "";
            document.getElementById("inp_foto2").value = "";
            document.getElementById("inp_foto3").value = "";
            document.getElementById("inp_foto4").value = "";
        }).catch(error => alert("Error: " + error.message));
    }

    function agregarMovimiento() {
        const prodName = document.getElementById("sel_movProd_input").value;
        const tipo = document.getElementById("sel_tipo").value;
        const cant = parseInt(document.getElementById("inp_cantidad").value);
        const ref = document.getElementById("inp_referencia").value || "-";

        if(!prodName || !cant) return alert("Faltan datos");

        let p = productos.find(x => x.nombre === prodName);
        if(!p) return alert("Producto no encontrado");

        let nuevoSaldo = p.saldo;
        if(tipo === "ENTRADA") nuevoSaldo += cant;
        else {
            if(p.saldo < cant) return alert("Stock insuficiente");
            nuevoSaldo -= cant;
        }

        const dataQR = `ID:${p.codigo}|Pr:${p.nombre}|Ub:${p.ubicacion}|St:${nuevoSaldo}`;
        const nuevoQR = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(dataQR)}`;

        db.collection("productos").doc(p.id).update({ saldo: nuevoSaldo, qr: nuevoQR });
        db.collection("movimientos").add({
            producto: prodName, tipo: tipo, cantidad: cant, referencia: ref,
            fecha: new Date().toLocaleString(), timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById("inp_cantidad").value = "";
            document.getElementById("inp_referencia").value = "";
            alert("Movimiento Registrado");
        });
    }

    function borrarProducto(idFirebase) {
        if(confirm("¬øEliminar producto?")) {
            db.collection("productos").doc(idFirebase).delete();
        }
    }

    // --- RENDERIZADO ---
    function actualizarTodo() {
        cargarSelects(); 
        buscarProducto();
        renderizarGaleria();
        mostrarMovPorProducto();
    }

    function mostrar(lista) {
        const t = document.getElementById("tablaProductos");
        t.innerHTML = "";
        if(lista.length === 0) { t.innerHTML = "<tr><td colspan='4'>Vac√≠o...</td></tr>"; return; }

        lista.forEach(p => {
            let imgPrincipal = (p.fotos && p.fotos.length > 0) ? p.fotos[0] : (p.foto || PLACEHOLDER);
            t.innerHTML += `
            <tr>
                <td><img src="${imgPrincipal}" class="prod-img"></td>
                <td>
                    <b style="color:white;">${p.nombre}</b><br>
                    <small style="color:#aaa;">ID:${p.codigo}</small><br>
                    <small style="color:#d1b3ff;">${p.ubicacion}</small>
                </td>
                <td style="font-weight:bold; color:#00e676; font-size:1.1em;">${p.saldo}</td>
                <td>
                    <button onclick="borrarProducto('${p.id}')" style="padding:5px; width:auto; background:#d32f2f;">üóë</button>
                    <a href="${p.qr}" download target="_blank"><img src="${p.qr}" style="width:30px; margin-left:5px;"></a>
                </td>
            </tr>`;
        });
    }

    function renderizarGaleria() {
        const container = document.getElementById("galeria-container");
        const filtro = document.getElementById("inp_buscar_gal").value.toLowerCase();
        container.innerHTML = "";

        const listaFiltrada = productos.filter(p => p.nombre.toLowerCase().includes(filtro) || p.codigo.toLowerCase().includes(filtro));

        if(listaFiltrada.length === 0) { container.innerHTML = "<p>No hay productos</p>"; return; }

        listaFiltrada.forEach(p => {
            // Asegurar que tenemos array de fotos
            let imgs = p.fotos || [p.foto || PLACEHOLDER, PLACEHOLDER, PLACEHOLDER, PLACEHOLDER];
            
            // Crear ID unico para cambiar imagen principal al hacer click
            let cardId = "card-" + p.id;

            container.innerHTML += `
            <div class="gallery-card">
                <img src="${imgs[0]}" class="gallery-main-img" id="img-${cardId}">
                <div class="gallery-thumbs">
                    <img src="${imgs[0]}" class="gallery-thumb" onclick="cambiarFoto('${cardId}', '${imgs[0]}')">
                    <img src="${imgs[1]}" class="gallery-thumb" onclick="cambiarFoto('${cardId}', '${imgs[1]}')">
                    <img src="${imgs[2]}" class="gallery-thumb" onclick="cambiarFoto('${cardId}', '${imgs[2]}')">
                    <img src="${imgs[3]}" class="gallery-thumb" onclick="cambiarFoto('${cardId}', '${imgs[3]}')">
                </div>
                <div class="gallery-info">
                    <h4>${p.nombre}</h4>
                    <p><span class="gallery-label">COD:</span> ${p.codigo}</p>
                    <p><span class="gallery-label">UBI:</span> ${p.ubicacion}</p>
                    <p><span class="gallery-label">STOCK:</span> <span style="color:#00e676">${p.saldo}</span></p>
                </div>
            </div>`;
        });
    }

    // Funcion helper para cambiar foto en la galeria
    window.cambiarFoto = function(cardId, url) {
        document.getElementById("img-" + cardId).src = url;
    }

    function buscarProducto() {
        const val = document.getElementById("inp_buscar").value.toLowerCase();
        const f = productos.filter(p => p.nombre.toLowerCase().includes(val) || p.codigo.toLowerCase().includes(val));
        mostrar(f);
    }

    function mostrarMovPorProducto() {
        const filter = document.getElementById("sel_movProd").value;
        const t = document.getElementById("tablaMovProd");
        t.innerHTML = "";
        let data = movimientos;
        if(filter && filter !== "TODOS") data = data.filter(m => m.producto === filter);

        data.forEach((m) => {
            let col = m.tipo === "ENTRADA" ? "#00e676" : "#ff1744";
            t.innerHTML += `
            <tr>
                <td class="no-print"><input type="checkbox" class="chk-print"></td>
                <td>${m.producto}<br><small style="color:#aaa">${m.referencia}</small></td>
                <td style="color:${col}; font-weight:bold;">${m.tipo.substring(0,3)}</td>
                <td style="font-weight:bold;">${m.cantidad}</td>
                <td style="font-size:0.75em; color:#bbb;">${m.fecha.split(',')[0]}</td>
            </tr>`;
        });
    }

    function cargarSelects() {
        const s1 = document.getElementById("sel_movProd");
        const s2 = document.getElementById("sel_movProd_input");
        const v1 = s1.value, v2 = s2.value;
        let ops = productos.map(p => `<option value="${p.nombre}">${p.nombre}</option>`).join('');
        s1.innerHTML = `<option value="TODOS">Todo</option>` + ops;
        s2.innerHTML = ops;
        if(v1) s1.value = v1;
        if(v2) s2.value = v2;
    }

    function crearFondoAnimado() {
        const bg = document.getElementById("bg-container");
        const chars = ['0', '1', '10', '01', '‚àë', 'œÄ', '‚à´', '‚àÜ', 'Œ©', 'Œ≤', 'Œª', '{ }', '</>', '0xFF'];
        for(let i=0; i<35; i++) {
            let el = document.createElement('div');
            el.className = 'floating-graphic';
            el.innerText = chars[Math.floor(Math.random() * chars.length)];
            el.style.left = Math.random() * 100 + 'vw';
            el.style.fontSize = (Math.random() * 35 + 15) + 'px'; 
            el.style.animationDuration = (Math.random() * 12 + 6) + 's'; 
            el.style.animationDelay = (Math.random() * 10) + 's';
            bg.appendChild(el);
        }
    }
    function iniciarEfecto3D() {
        const cards = document.querySelectorAll('.dash-card');
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left; 
                const y = e.clientY - rect.top;  
                const rotateX = ((y - (rect.height/2)) / (rect.height/2)) * -20; 
                const rotateY = ((x - (rect.width/2)) / (rect.width/2)) * 20;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            card.addEventListener('mouseleave', () => card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg)`);
        });
    }
    function toggleMenu() { document.getElementById('navMenu').classList.toggle('show'); }
    function irA(vistaId, nombreVista, btnId) { navegar(vistaId, nombreVista, document.getElementById(btnId)); }
    function navegar(vistaId, nombreVista, btnElement) {
        document.getElementById('navMenu').classList.remove('show'); 
        document.getElementById('menu-title').innerHTML = "‚ò∞ " + nombreVista;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        const vistaActual = document.querySelector('.tab-content.visible');
        const vistaNueva = document.getElementById(vistaId);
        if (vistaActual === vistaNueva) return;
        if(vistaActual) {
            vistaActual.classList.remove('visible');
            setTimeout(() => {
                vistaActual.classList.remove('display-block');
                vistaNueva.classList.add('display-block');
                setTimeout(() => { vistaNueva.classList.add('visible'); }, 50);
                if(vistaId !== 'view-dashboard') actualizarTodo();
            }, 500); 
        } else { vistaNueva.classList.add('display-block', 'visible'); }
    }
    function getSelected() {
        const chks = document.querySelectorAll('.chk-print:checked');
        let rows = chks.length ? Array.from(chks).map(c=>c.closest('tr')) : Array.from(document.querySelectorAll('#tablaMovProd tr'));
        return rows.map(r => {
            let d = r.querySelectorAll('td');
            if(!d.length) return null;
            return [d[1].innerText, d[2].innerText, d[3].innerText, d[4].innerText].join(',');
        }).filter(x=>x);
    }
    function exportarExcel() {
        const csv = "Producto/Ref,Tipo,Cant,Fecha\n" + getSelected().join('\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        a.download = 'reporte_alp13.csv';
        a.click();
    }
    function enviarCorreo() {
        const body = getSelected().join('%0D%0A');
        window.location.href = `mailto:?subject=Reporte ALP13&body=${body}`;
    }
    function imprimirSeleccion() {
        window.print();
    }
</script>
</body>
</html>
